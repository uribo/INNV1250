---
title: 統計的推測
keep-ipynb: true
execute: 
  eval: true
  echo: true
jupyter:
  jupytext:
    formats: 'ipynb,qmd'
    text_representation:
      extension: .qmd
      format_name: quarto
      format_version: '1.0'
      jupytext_version: 1.14.5
  kernelspec:
    display_name: R
    language: R
    name: ir
---

統計的推測（Statistical Inference）とは、母集団から標本を抽出し、その標本から母集団の性質を推測する手法のことです。統計的推測には、**推定**と**仮説検定**の2つの手法があります。これらの手法では、先週（第6回）の講義で扱った、母集団・標本、確率変数と確率分布が基礎となります。推定と仮説検定についてそれぞれ説明します。

## 母数と統計量

母集団から標本を抽出すると、標本には母集団の性質を表す情報が含まれています。この標本から母集団の性質を推測するために抽出される情報を、**統計量**と呼びます。統計量は、母集団の性質を表す**母数**（パラメータ）の推定に用いられます。母数は一般に未知であり、点推定や区間推定によってその値を「推定」します。

母集団と標本の間での性質の対応関係を表したものを、以下の表にまとめます。

| 対象 | 母数 | 統計量 |
|:-----|------|--------|
| データの値の合計をデータの数で割った値。データの代表値 | 母平均 $\mu$ | 標本平均 $\bar{x}$ |
| データの値が平均値からどれだけ離れているかを示す尺度 | 母分散 $\sigma^2$ | 標本分散 $S^2$ |
| データの値が平均値からどれだけ離れているかを示す尺度[^1] | 母標準偏差 $\sigma$ | 標本標準偏差 $S$ |

[^1]: 標準偏差は分散の正の平方根として定義されます。分散は元のデータの単位を2乗したものになるため、単位の解釈や平均値との比較が難しくなります。しかし、標準偏差を用いることで、単位を元の形に戻すことが可能となり、平均値との比較や解釈がより直感的になります。

## （母数の）推定

母数の推定方法には、**点推定**と**区間推定**の2つの主要な手法があります。点推定では、母数の値を1つの数値で表現します。一方、区間推定では、母数がとりうると予想される範囲・区間を推定します。これには、不確実性や信頼水準を考慮し、母数が存在する可能性のある範囲を示します。

<!-- 確率分布を利用する -->

### 点推定

点推定の例を紹介します。あるクラスの生徒30名を母集団とし、生徒の身長を調査するために無作為抽出法で10名の生徒を選び、以下のデータを得ました。このデータを元に、クラス全体の平均身長を推定したいとします。この場合、点推定は、単一の値である「推定された平均身長」を使用して推定を行います。

```{r}
set.seed(123)
# 正規分布に従う、平均167、分散4の乱数を30個生成し、母集団とする
# 母集団は一般に未知であるが、ここでは「神の視点」で母集団の性質を知っていると仮定する
x <- 
  floor(rnorm(n = 30, mean = 167, sd = sqrt(4)))

sample_x <- 
  sample(x, size = 10, replace = FALSE)
```

標本から計算される平均値は標本平均と呼ばれます。この値は、母集団の平均値を推定するための点推定量として使用されます。標本平均は、以下の式で計算されます。

$$
\bar{x} = \frac{1}{n}\sum_{i=1}^{n}x_i
$$

```{r}
# 標本集団の平均値（標本平均）
mean(sample_x)

# 母集団の平均値（母平均）
mean(x)
```

この場合、標本平均は`r mean(sample_x)`となりました。この値は標本抽出を行った母集団の性質（平均、この場合は母平均は`r mean(x)`）とほぼ同じ値となっています。言い換えると、この標本から推定された平均身長は、母集団の平均身長を推定するための良い推定量であると言えます。これは母集団からの標本抽出が適切に機能したことを意味します。

一方、標本抽出が適切に機能しなかった場合、標本平均は母平均とは異なる値となります。この場合、標本平均は母平均の推定量としては不適切であると言えます。その背景には、標本が偏りのあるものであったり、標本抽出が無作為ではなかったりすることが考えられます。

```{r}
# 偏りのある標本から得られた標本の標本平均
# たまたま、身長が低い生徒から標本が得られたと仮定する
sample_x2 <- 
  sort(x)[1:10]
mean(sample_x2)
#> [1] 164.2
```

偏りのある標本をもとに標本平均を推定すると、真の値である母平均との差が大きくなり、母集団について誤った理解をしてしまう原因となります。

こうした推定量の性質を評価するために、推定量の**不偏性**や**一致性**といった性質を考えることがあります。不偏性とは、推定量の期待値が真の値と一致する性質です。一致性とは、標本の大きさが大きくなるにつれて推定量が真の値に近づく性質です。不偏性や一致性を満たす推定量は、母集団の性質を推定するための良い推定量であると判断できます。

加えて、推定には不確実性や誤差の評価が含まれます。推定結果が真のパラメータや母集団の特性にどれだけ近いかといった推定結果の信頼性を評価する指標として推定結果の**信頼区間**、誤差の大きさを評価する指標として**標準誤差**を利用します。推定の信頼性が高いほど、推定結果が真の値に近いと言え、誤差の大きさが小さいほど、推定結果の信頼性が高いと言えます。

### 区間推定

区間推定は、点推定の結果に対する不確実性を評価するための手法です。点推定値に一定の範囲（すなわち信頼区間）を加えることで、その区間内に真の母数が含まれる確率を表現します。これにより、推定値の精度を定量的に評価し、統計的な結論を導く際の不確実性を考慮することが可能となります。

標本平均を使った母平均の信頼区間は、以下の式で計算されます。

$$
\bar{x} \pm t_{\alpha/2}\frac{s}{\sqrt{n}}
$$

ここで

- $\bar{x}$　は標本平均
- $t_{\alpha/2}$は自由度 $n-1$ の $t$ 分布の上側 $\alpha/2$ 点
- $s$ は標本標準偏差または不偏標準偏差
- $n$ は標本の大きさ

をそれぞれ表します。先ほどの身長のデータで計算してみましょう。

```{r}
n <- length(sample_x) # 標本の大きさ
t <- qt(0.975, df = n - 1) # t分布の上側2.5%点。自由度(degree of freedom)はn-1
s <- sd(sample_x)

standard_error <- sd(sample_x) / sqrt(n) # 標準誤差

# 信頼水準95%の信頼区間（95%信頼区間）
(lower_limit <- mean(sample_x) - t * standard_error) # 信頼区間の下限
(upper_limit <- mean(sample_x) + t * standard_error) # 信頼区間の上限
```

なお、95%信頼区間は`t.test()`関数を使っても求めることができます。

```{r}
# 信頼区間の下限と上限、95%信頼区間であることを出力
t.test(sample_x)$conf.int

# 信頼区間の下限と上限、99%信頼区間であることを出力
# t.test(sample_x, conf.level = 0.99)$conf.int
```

ここで得られる値は「区間」を示す2つの値です。この2つの値の間に真の母平均が含まれる確率を**信頼水準**と呼びます。信頼水準は、$t$ 分布の上側 $\alpha/2$ 点と下側 $\alpha/2$ 点によって決まります。これらの点は、$t$ 分布の確率密度関数が平均値を中心にして対称であることを利用したもので、上側 $\alpha/2$ 点は下側 $\alpha/2$ 点と対称になります。したがって、信頼水準が95%の場合、上側2.5%点と下側2.5%点の間に母平均が含まれる確率が95%となります。

95%信頼区間は複数回の標本抽出を行った場合に、95%の標本に対して信頼区間が母平均を含むことを意味します。

実際に「神の視点」で見た母平均は`r mean(x)`なので、確かにこの区間に含まれていることがわかりますが、異なる標本を用いて信頼区間の推定を100回行った場合には、95回は信頼区間の範囲に母平均が含まれることが期待されますが、5回は母平均を含まない信頼区間が得られることになります。

```{r}
# 信頼区間の範囲に母平均が含まれる
dplyr::between(mean(x), lower_limit, upper_limit)

# 100個の標本について信頼区間を求めると、平均して5つは母平均を含まない値を得る
set.seed(123456)
d <- tibble::as_tibble(as.data.frame(matrix(nrow = 100, ncol = 3)))
for (i in seq.int(100)) {
  ci <- t.test(sample(x, size = 10, replace = FALSE))$conf.int
  d[i, ] <- tibble::tibble(
    lower_limit = ci[1],
    upper_limit = ci[2],
    mean_x = mean(x)
  )
}
d <- 
  setNames(d, c("lower_limit", "upper_limit", "mean_x"))
# 信頼区間が母平均を含まない場合
d |> 
  dplyr::mutate(check = dplyr::between(mean_x, lower_limit, upper_limit)) |> 
  dplyr::filter(check == FALSE)
```

## 仮説検定

仮説検定は、母集団の特性に関する仮説を立て、与えられたデータからその仮説が正しいかどうかを検証する方法です。この過程では、帰無仮説と対立仮説という二つの仮説を設定します。帰無仮説は通常、保持したい主張や状況のない場合を表すもので、対立仮説は帰無仮説とは反対の状況を表します。例えば、2つのクラスでの生徒の身長について、「差がある」とする仮説と「差がない」とする仮説を立てることができます。この場合、「差がない」とする仮説が帰無仮説、「差がある」とする仮説が対立仮説となります。仮説検定の目的は、観測データが帰無仮説により説明可能か、それとも対立仮説の下でより説明可能かを判断することです。

この検証は、帰無仮説が正しい、つまり「差がない」と仮定した場合に、観測データがどれほど稀なものなのかを、p値で評価します。p値は、帰無仮説のもとで観測データと同じかそれ以上に極端なデータが得られる確率を表します。p値はある設定した閾値（有意水準 $alpha$ 、通常は5%や1%）より小さければ、観測データが帰無仮説のもとで得られることは稀であることを意味します。この場合、帰無仮説は棄却され、対立仮説が採択されます。p値が大きい場合は、帰無仮説が採択されます。

ここで重要なのは、有意水準が、帰無仮説が正しいにも関わらず、帰無仮説を誤って棄却してしまう確率を表しているということです。つまり、有意水準を $\alpha$ とした場合、我々が帰無仮説を誤って棄却する確率は最大でも $\alpha$ となります。

### 仮説検定の手順

仮説検定の手順は以下の通りです。

1. 帰無仮説と対立仮説を設定する
2. 有意水準 $\alpha$ を設定する
3. 検定統計量を計算する
4. 検定統計量の分布を決定する
5. 検定統計量の実現値を計算する
6. p値を計算する

### Rによる仮説検定の実行例

仮説検定の例として、あるクラスの生徒の身長について、男女で平均値に差があるかどうかを検証します。この場合、帰無仮説は「男女で身長に差がない」、対立仮説は「男女で身長に差がある」です。有意水準は5%とします。

```
帰無仮説: 男女間で身長の平均値の差はない

対立仮説: 男女間で身長の平均値の差がある
```

```{r}
# 男女別でのクラスの生徒の身長
height_male <- 
  c(160, 162, 165, 167, 168, 170, 171, 172, 173, 173)
height_female <- 
  c(156, 158, 161, 163, 164, 162, 167, 154, 169, 171)
```

```{r}
library(ggplot2)

tibble::tibble(type = rep(c("male", "female"), each = 10), 
               height = c(height_male, height_female)) |> 
  ggplot() +
  aes(type, height) + 
  geom_violin(aes(fill = type), show.legend = FALSE) +
  scale_fill_manual(values = c(male = "#0cb3d1",
                               female = "#f25d02"))
```

2つの標本に対する平均値の差を検定する場合、t検定を行います。t検定は、標本の平均値の差が正規分布に従うと仮定した場合に、標本の平均値の差が0であるという帰無仮説を検証します。

t検定は、t値と呼ばれる検定統計量を計算し、t値の分布を決定することでp値を計算します。具体的には、帰無仮説（通常は「母平均は特定の値である」という仮説）が正しい場合のt値の分布（つまり、t分布）を考え、実際に観測されたt値がその分布に基づいてどれほどあり得ないか（p値）を計算します。p値があらかじめ設定した有意水準よりも小さければ、帰無仮説を棄却します。

t値は、次の式で計算されます。ここで、$\bar{x_1}$ と $\bar{x_2}$ はそれぞれ2つの標本の平均値、$s_1$ と $s_2$ はそれぞれ2つの標本の標準偏差、$n_1$ と $n_2$ はそれぞれ2つの標本の標本数です。


$$
t = \frac{\bar{x_1} - \bar{x_2}}{\sqrt{\frac{s_1^2}{n_1} + \frac{s_2^2}{n_2}}}
$$

Rを用いて計算してみます。

```{r}
# 各標本の平均を計算
M1 <- mean(height_male)
M2 <- mean(height_female)

# 各標本の標準偏差を計算
s1 <- sd(height_male)
s2 <- sd(height_female)

# 各標本のサイズを計算
n1 <- length(height_male)
n2 <- length(height_female)

# t値を計算
(t_value <- (M1 - M2) / sqrt((s1^2/n1) + (s2^2/n2)))
```

t値の分布は、自由度が $n_1 + n_2 - 2$ のt分布に従います。自由度とは、t分布の形状を決定するパラメータで、t分布においては標本数から2を引いた値になります。

t分布の上側5%点は、自由度が $n_1 + n_2 - 2$ のt分布に従う確率変数の値のうち、上側5%に入る値です。t分布の上側5%点は、Rの関数 `qt()` を用いて計算できます。

```{r}
# t分布の上側5%点を計算
qt(0.95, df = (n1 + n2)-2)
```

この値をt値と比較することで、帰無仮説を棄却するかどうかを判断します。今回の場合、t値は上側5%点よりも大きいため、帰無仮説を棄却します。つまり、男女で身長に差があるという結論になります。

```{r}
t_value >= qt(0.95, df = (n1 + n2)-2)
```

p値は、t値の分布を考えることで計算できます。今回の場合、t値は自由度が $n_1 + n_2 - 2$ のt分布に従う確率変数です。t分布の上側5%点は、t値が上側5%に入る確率を表しています。t値が上側5%に入る確率は、t分布の上側5%点を超える確率と同じです。つまり、p値はt分布の上側5%点を超える確率と同じになります。

```{r}
# p値を計算
p_value <- 1 - pt(t_value, df = (n1 + n2)-2)
# 両側検定の場合は、p値を2倍する
(p_value <- p_value*2)
```

::: {.callout-tip title="片側検定と両側検定"}

片側検定と両側検定は、仮説検定において使用される検定の手法です。片側検定では、検定統計量が片側の分布の特定の領域に入るかどうかを確認し、その確率を計算します。この確率をp値として解釈します。一方の検定統計量が両側の分布の両側の領域に入るかどうかを確認、その確率をp値として利用します。そのため、同じ有意水準であっても片側検定と両側検定で異なるp値を評価し、帰無仮説を棄却するかどうかを判断することになります。

どちらの検定手法を使用するかは、検定結果をどのように解釈するか、あるいは研究の目的や仮説によって決まります。

:::

これまでの処理を`t.test()`関数を用いて確認しましょう。t検定には、2つの標本の分散が等しいという仮定が必要です。この仮定が成り立たない場合は、Welchのt検定を行います。

```{r}
# 2つの標本のt検定 (Studentのt検定)
# var.equal = TRUE により2つの標本の分散が等しいと仮定する
t_test <- t.test(height_male, height_female, var.equal = TRUE)
t_test
```

## 問題

ある都道府県の高等学校に通う13歳の男女それぞれ30名について身長を調べたところ、男子の平均値は160.4cm、標準偏差7.90cm、女子の平均値は154.2cm、標準偏差7.90となりました。身長が正規分布に従うと仮定し、男女の平均値に差があるかの仮説検定を行うRコードを記述し、結果を出力してください。

```{r}
# ここに仮説検定を行うためのRコードを記述してください。
# 平均値と標準偏差の2つのパラメータから、正規分布に従うデータを生成します。
# まず、男子についてrnrom()関数を使い、データを生成します。続いて同様に女子30名の身長データを生成します。
male <- rnorm(n = 30, mean = 160.4, sd = 7.90)
```


仮説検定の結果、有意水準1%で統計的に有意に差があると言えますか。

```
1. 統計的な有意差がある
2. 統計的な有意差はない
```
